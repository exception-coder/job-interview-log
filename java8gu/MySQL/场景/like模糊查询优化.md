MyISAM_Index_Structure_And_Problems
✔ 索引与数据物理分离、叶子只存地址
⚠️ 所有索引都是非聚簇，必然回表
📌 两次读取：先定位地址再查数据
🧠 不适合高频主键查找
🔥 InnoDB 引入聚簇索引彻底补坑
🚀 MyISAM 结构简单但随机 IO 多
🔍 不支持事务、页面崩溃恢复弱
➤ 主键不具备唯一物理排序能力
✨ 检索路径长、磁盘寻址开销大

---

## 折叠式知识卡片版

<details>
<summary>① 定义</summary>

* MyISAM 使用 **索引文件（.MYI）与数据文件（.MYD）分离** 的架构。
* 索引结构为 B+Tree，但**叶子节点存放的是数据行的物理地址**而非数据本身。
* 因此 MyISAM **没有聚簇索引的概念**，所有索引均为非聚簇索引。

</details>

<details>
<summary>② 原理</summary>

* 索引查找流程：

    1. B+Tree 根据 key 搜索得到记录地址；
    2. 通过地址读取数据文件中的真实数据。
* 由于数据与索引分离，数据文件中记录存储顺序与索引 key 无关。
* 任意索引查询都涉及 **索引查找 + 回表一次**，无法避免二次 IO。
* 与 InnoDB 聚簇索引形成对比：InnoDB 的叶子节点即存储行数据，可直接返回，无需回表。

</details>

<details>
<summary>③ 关键点</summary>

* **所有查询都要回表** → 多一次随机 IO。
* **物理地址存储导致数据移动成本高**（行扩张会造成碎片，需修复）。
* **主键无物理排序能力** → 主键查找并不更快。
* **高并发性能弱**，不支持行级锁。
* **无事务/崩溃恢复能力**（非 WAL，可靠性弱）。
* 在只读或查询多、更新少场景有一定优势，但 InnoDB 完全取代。

</details>

<details>
<summary>④ 扩展知识</summary>

* 文档未提及但合理补充：MyISAM 会出现“表损坏”（MYI/MYD 不一致），需使用 `myisamchk` 修复。
* MyISAM 不支持外键，也不支持 MVCC，因此在现代 OLTP 场景下已被 InnoDB 完全替代。
* 只读型应用（日志分析、全文索引旧版本）曾经使用，但现在有更优方案如 InnoDB + FTS、ElasticSearch。

</details>

---

## 面试官追问（Q&A）

**问：为什么 MyISAM 所有索引都是非聚簇？**
答：因为索引与数据文件物理分离，叶子节点只能存地址，不可能把数据放进去，因此无法构建聚簇索引。

**问：MyISAM 必然回表的根本原因是什么？**
答：叶子节点不存数据本体，而是存物理偏移地址，必须继续读取数据文件。

**问：为什么 MyISAM 主键无优势？**
答：主键索引和普通索引结构完全相同，均为非聚簇索引，主键不会影响数据实际物理顺序。

**问：数据文件存物理地址有何弊端？**
答：行更新、变长字段导致地址变化，造成数据迁移和碎片，需要频繁维护。

**问：MyISAM 比 InnoDB 慢在哪？**
答：缺页缓存管理、无聚簇索引、无行锁、无事务支持，随机 IO 多，写入并发极差。

**问：为什么 InnoDB 引入聚簇索引？**
答：为减少随机 IO、提升主键查找性能，并构建事务 + MVCC 所需的存储结构。

**问：MyISAM 什么时候还能使用？**
答：极少数只读场景，但从 MySQL 5.7+ 起基本被弃用，不推荐新项目使用。

---

## 示意图（ASCII）

```
MyISAM 索引查找流程（非聚簇）

        B+Tree（索引文件 .MYI）
               ┌──────────┐
               │   key     │
               └─────┬────┘
                     │ 查到记录地址 offset
                     ▼
        数据文件（.MYD）
   ┌─────────────────────────┐
   │  根据 offset 定位真实行数据 │
   └─────────────────────────┘

→ 必然两次读取：索引 + 数据文件
```

（完）
