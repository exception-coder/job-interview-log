auto_increment_gap_cases

✔ 自增主键唯一但绝不保证连续
🔥 回滚插入最常见跳号来源
📌 删除记录永不回填主键
🚀 手动插入大值会直接推高计数器
⚠️ 重启可能丢失未持久化计数
➤ ON DUP KEY UPDATE 会白白消耗主键
🧠 自增值只增不减是InnoDB设计
📈 导入数据可能造成大片不连续
🔍 修改自增起始值也会制造跳跃
✘ 想“连续”只能靠业务模拟不能靠MySQL

---

<details>
<summary>定义</summary>

**自增主键不连续**：AUTO_INCREMENT 值序列中出现跳号，即已有分配的值因事务失败、删除或其他原因未在表中形成实际记录，导致序列非严格连续。

InnoDB 的设计目标是保证 **唯一性**，不是连续性，因此跳号属于正常行为。

</details>

<details>
<summary>原理</summary>

* 自增值分配依赖 AUTO-INC 锁，分配即刻递增，不随事务回滚回退。
* 删除不会回收主键值，避免高并发下修改全表结构。
* 手动指定值会推进自增计数器。
* 重启后 InnoDB 会从“已持久化的最大值 + 1”重新开始，未持久化的分配会丢失。
* `ON DUPLICATE KEY UPDATE` 尝试插入即会申请自增值，即使最终走更新路径也会增加序列。

</details>

<details>
<summary>关键点</summary>

* 事务回滚导致“已分配但未落表”的主键永远丢失。
* 删除行造成自然间隙，不会回填。
* 导入数据含自增列时可能直接制造大跨度跳号。
* 修改表的 `AUTO_INCREMENT` 或使用 `ALTER TABLE` 调整起始值会造成显式跳号。
* 重启带来的跳号取决于 redo/log 写入时点，属于正常现象（合理补充）。

</details>

<details>
<summary>扩展知识</summary>

* InnoDB 提供三种 AUTO_INCREMENT 锁模式（0/1/2），不同模式下批量插入的跳号幅度不同（合理补充）。
* 自增主键的非连续性对性能有利，减少页分裂，适合作为聚簇索引主键（合理补充）。
* 若业务强依赖连续编号，应使用独立序列服务或专用号段系统，而非AUTO_INCREMENT（合理补充）。

</details>

---

**问：为什么事务回滚会导致自增主键不连续？
答：自增值在分配时就已递增，但回滚不会回收该值，导致序列跳号。**

**问：删除数据为什么不回收主键？
答：回收需修改大量索引结构，代价极高且影响并发，因此 InnoDB 不支持。**

**问：ON DUPLICATE KEY UPDATE 怎么造成跳号？
答：插入阶段先分配主键，后续改为更新也不会回收，因此主键单向增加。**

**问：服务器重启为什么影响连续性？
答：部分已分配但未写入持久存储的自增值丢失，从最大持久值继续分配产生跳号。**

**问：手动插入大值为什么会改变序列？
答：自增计数器会被推进到更大的值用于保证后续唯一性。**

**问：数据导入为什么可能导致严重不连续？
答：导入文件中若包含主键值，InnoDB 会采用这些值并更新计数器，造成大跳号。**

**问：如何保证严格连续？
答：不能依赖 AUTO_INCREMENT，应采用序列服务或业务分布式号段。**

**问：轻量级 AUTO-INC 锁对连续性有什么影响？
答：不影响连续性，只提高并发；跳号属于设计行为而非锁模式问题。**

---

```
     ┌───────────────────────────┐
     │     AUTO_INCREMENT 跳号原因 │
     └──────────────┬────────────┘
                    │
   ┌────────────────┴────────────────┐
   │                                 │
┌───────────────┐          ┌──────────────────┐
│ 已分配但未落表 │          │ 计数器被显式推进     │
├───────────────┤          ├──────────────────┤
│ 事务回滚       │          │ 手动指定主键值        │
│ ON DUP KEY     │          │ 导入含主键的数据       │
└───────────────┘          │ 修改自增起始值/重启     │
                           └──────────────────┘
```
