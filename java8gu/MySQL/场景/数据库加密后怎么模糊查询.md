DB_Encrypt_Fuzzy_Query
✔ 加密后密文无序，与明文无任何关联
⚠️ 直接 like 明文必然失效
📌 四类方案都无法利用索引
🔥 最终均是空间换灵活性
🧠 分词/拆段可部分支持模糊
🚀 解密逐条匹配最简单但最慢
🔍 映射表方案等于泄露明文
➤ DB 函数查询能用但全表扫
✨ 大厂常用“明文分词+加密拼接”

---

## 折叠式知识卡片版

<details>
<summary>① 定义</summary>

* 数据库字段加密后，密文无序、不可预测，无法用于任何索引匹配；
* 因此 **加密字段的模糊查询天然不可能直接实现**，需依靠额外结构或逻辑支持。
* 文档介绍四类典型方案：解密匹配、明文映射、数据库函数、明文分词。

</details>

<details>
<summary>② 原理</summary>

### 1）先解密再查询

* 将所有候选记录加载至内存，逐条解密并做模糊匹配。
* 可行但极低效，且可能 OOM。

### 2）明文映射表

* 单独维护“明文 → 主键”表，再用主键查目标表。
* 本质把明文暴露出来，破坏加密意义。

### 3）数据库解密函数

* 查询时执行 `WHERE AES_DECRYPT(field,key) LIKE 'Ho%'`
* 因字段上使用函数 → **索引失效，全表解密扫描**。
* 适合数据量较小或其他字段可走索引的情况。

### 4）明文分词

* 将明文拆成多个片段（如 “Hollis” → “Ho”, “Hol”, “oll”, “lis”…），逐个加密存储。
* 查询时将查询明文片段加密再匹配。
* 缺点：字段冗余多、不够灵活（例如查询“Holli”时未覆盖）。
* 改进：所有片段加密后拼成一个字段（如 JSON/逗号分隔），对该字段做 like 查询（依旧无法走索引）。

</details>

<details>
<summary>③ 关键点</summary>

* **任何加密字段都无法做索引模糊查询**，因为密文分布随机。
* 所有方案都属于“变通”，其核心代价是：性能、空间、维护复杂度。
* 明文分词是主流方案（大厂如淘宝、拼多多均采用），但最终还是全表扫描字段。
* 理论上存在“可搜索加密（Searchable Encryption）”，但极重，不适合业务落地。

</details>

<details>
<summary>④ 扩展知识</summary>

* 现代系统常将可检索字段进行脱敏存储（如 mask、hash 前缀）而非加密，以允许走索引。
* 也可通过 ES / 搜索引擎进行明文检索，再回库查密文。
* 同态加密/可搜索加密可从密码学上解决，但远未到工程可落地阶段（此为合理补充）。

</details>

---

## 面试官追问（Q&A）

**问：为什么密文无法进行任何索引模糊匹配？**
答：加密确保密文分布近似随机，无法保留明文字段的字典序或前缀结构，B+Tree 完全无法利用。

**问：为什么使用 AES_DECRYPT(field,key) LIKE 'xxx%' 会导致索引失效？**
答：因为字段被函数包裹，优化器无法基于原列值进行范围推导，只能对每行执行解密。

**问：为什么明文映射表方案不安全？**
答：攻击者一旦拖库，直接获得“明文 → 主键”关系，相当于数据完全裸奔。

**问：明文分词方案的根本限制是什么？**
答：无法覆盖任意长度的前缀/子串，只能覆盖固定粒度的拆分，且存储成本高。

**问：大厂为什么仍使用分词方案？**
答：在隐私要求强但仍需模糊检索的领域（如手机号、姓名）是可落地权衡，字段冗余可接受。

**问：能否用全文检索解决加密模糊查询？**
答：全文索引需要明文或可分词结构，加密后无法解析，故不可行。

**问：业务上如何规避加密字段模糊查询？**
答：通常用“展示字段加密 + 查询字段脱敏/hash/拆分”等组合设计。

---

## 示意图（ASCII）

```
加密字段 = 无序密文
Ho ——AES→ A1B2C3...
Holl ——AES→ F9E8D7...
密文之间毫无顺序结构 → LIKE 无法命中索引

解决思路（本质绕过）：
   ┌──────────────────────┐
   │ 明文分词 → 多段加密   │
   │ 查询明文 → 加密匹配   │
   └──────────────────────┘
→ 可匹配，但不可使用索引
```

（完）
