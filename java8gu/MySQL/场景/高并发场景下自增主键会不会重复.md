high_concurrency_auto_increment_pk

✔ 单库高并发自增主键不会重复
🔥 唯一性由 AUTO-INC 锁序列化分配保证
📌 轻量级 AUTO-INC 锁插入后立即释放
🚀 并发插入可持续推进 ID，不互相阻塞事务
⚠️ 分库分表环境不保证不重复
➤ 旧版本表级 AUTO-INC 锁并发差但仍保证唯一
🧠 自增值分配不依赖事务提交顺序
📈 逻辑重复不可能，但物理不连续是常态
🔍 AUTO_INCREMENT 本质是“全局单点序号发生器”
✘ 自增唯一≠连续保证

---

<details>
<summary>定义</summary>

**AUTO_INCREMENT 主键**：由 InnoDB 负责分配的递增数值，用于确保主键唯一性。

**AUTO-INC 锁**：InnoDB 为自增列分配值时使用的内部序列化锁，控制自增计数生成过程，保证插入并发场景下的唯一性。

</details>

<details>
<summary>原理</summary>

* 插入行时，InnoDB 申请 AUTO-INC 锁，根据当前计数器生成唯一自增值。
* 新自增值分配完成后即释放锁（MySQL 5.1+ 的轻量级 AUTO-INC 策略）。
* 轻量级锁生命周期仅覆盖“分配值”阶段，不会等到事务提交，提高并发。
* 即便事务最终回滚，已分配的自增值也不会重用，从而保证唯一但不保证连续。
* 老版本（≤5.0/部分5.1）锁是“表级且锁住整个事务”，但仍不会导致重复。

</details>

<details>
<summary>关键点</summary>

* 单表自增主键在高并发下**绝不会重复**。
* 即使插入失败或事务回滚，自增值也不会回滚，因此可能出现不连续。
* 分库分表若不做全局 ID 方案，会出现重复（文档未描述，合理补充）。
* AUTO-INC 锁保护的是自增值分配，不是整行插入流程。
* 并发插入越高，轻量级 AUTO-INC 锁优势越明显。

</details>

<details>
<summary>扩展知识</summary>

* 可配置 `innodb_autoinc_lock_mode`：

    * 0：传统表级锁
    * 1：轻量级锁（MySQL 默认）
    * 2：允许批量插入分配“预申请区间”（合理补充）
* 自增值在崩溃恢复后可能跳号，因为值分配与 redo 写入非强同步（合理补充）。
* 自增列适合作为聚簇索引主键，顺序写入减少页分裂（合理补充）。

</details>

---

**问：高并发下自增主键为什么不会重复？
答：AUTO-INC 锁将“自增值分配”过程串行化，保证每次分配都是唯一的。**

**问：轻量级 AUTO-INC 锁与旧版表级锁的区别？
答：轻量级锁在值分配完立即释放，旧版要等事务结束；新机制更高并发，但两者都保证唯一。**

**问：自增主键是否保证连续？
答：不保证。失败插入、回滚、批量插入都会造成跳号。**

**问：并发越高是否会增加重复风险？
答：不会。自增唯一性由锁机制严格控制，与并发量无关。**

**问：为什么分库分表会产生主键重复？
答：每个分片有独立的 AUTO_INCREMENT 计数器，缺乏全局协调（文档未提，合理补充）。**

**问：自增值分配与事务提交顺序一致吗？
答：不一致，分配顺序受 AUTO-INC 锁控制，与事务最终提交先后无关。**

**问：大批量插入会影响自增行为吗？
答：会产生“区间申请”并可能导致跳号，但不会导致重复。**

**问：AUTO_INCREMENT 会不会因为崩溃恢复而回退？
答：不会，值只增不减，但可能出现跳号。**

---

```
          ┌────────────────────┐
          │   AUTO_INCREMENT   │
          └─────────┬──────────┘
                    │
            ┌─────────────┐
            │ AUTO-INC锁机制 │
            └───────┬─────┘
                    │
     ┌──────────────┴──────────────┐
     │                               │
┌──────────────┐            ┌────────────────┐
│ 唯一性保证     │            │ 不保证连续性       │
├──────────────┤            ├────────────────┤
│ 串行分配ID    │            │ 回滚/批量导致跳号    │
│ 并发不影响     │            │ 崩溃恢复可能跳号     │
└──────────────┘            └────────────────┘
```
