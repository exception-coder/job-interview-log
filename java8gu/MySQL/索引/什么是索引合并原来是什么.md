index_merge_principle

✔ 索引合并允许“一条 SQL 同时用多个索引”
🔥 AND → 交集；OR → 并集；排序需求 → sort_union
📌 执行计划会显示 type=index_merge
🚀 解决单列索引不足但全表扫太慢的问题
⚠️ 不是越多索引越快，merge 也要付代价
🔍 交集(intersect)常用于多条件精确过滤
📈 并集(union)适用于 OR 查询拆分多索引
🧠 sort_union 会先按索引获取再统一排序
➤ 复合索引通常优于 index merge
✘ 滥用 index merge 会导致回表成本倍增

---

<details>
<summary>定义</summary>

**索引合并（Index Merge）**：MySQL 优化器的一种策略，通过对多个单列索引分别检索并合并结果（交集/并集/排序合并），得到最终满足条件的行，适用于多条件查询但无复合索引的场景。

</details>

<details>
<summary>原理</summary>

* MySQL 先对每个可用索引分别扫描得到候选主键 ID 列表。
* 根据查询逻辑选择合并方式：

    * **intersect**：AND 条件 → 多索引结果求交集
    * **union**：OR 条件 → 多索引结果求并集
    * **sort_union**：需排序时 → 多索引结果合并并排序
* 最终对合并出的主键集进行回表，取实际数据行。

</details>

<details>
<summary>关键点</summary>

* index merge 无法避免回表，合并结果越大回表成本越高。
* 复合索引在大部分场景优于 index merge，因为可直接有序过滤，无需合并。
* index merge 适合：多个高选择性单列索引 + 无复合索引方案。
* 出现在 EXPLAIN 的 `type=index_merge`、`key=idx_a,idx_b`。
* 不适合数据量大、选择性差的 OR/AND 组合查询。

</details>

<details>
<summary>扩展知识</summary>

* 可通过 `optimizer_switch='index_merge=off'` 禁用 index merge（合理补充）。
* index merge 常配合 “index condition pushdown (ICP)” 降低回表成本（合理补充）。
* merge 的代价模型依赖统计信息，不准时可能选错执行路径。

</details>

---

**问：为什么需要索引合并？
答：当不存在复合索引、但多个单列索引各自有效时，优化器可用 index merge 减少扫描范围。**

**问：交集和并集的场景区别？
答：AND → intersect，过滤性强；OR → union，通常结果集更大回表更多。**

**问：index merge 和复合索引哪个更好？
答：一般复合索引更优，因为无需合并与排序，减少回表。merge 是折中方案。**

**问：sort_union 在什么情况下出现？
答：使用多个索引筛选数据且带 ORDER BY，需要对多个索引的结果排序后才能返回。**

**问：index merge 会选错吗？
答：会，统计信息不准、基数估计偏差都会让优化器错误地选择 index_merge。**

**问：如何判断 index merge 是否值得？
答：看每个索引返回行数是否足够小，否则合并成本和回表成本都过高。**

**问：index merge 能加速 join 吗？
答：仅在 join 条件的子查询部分可以帮助过滤，无法替代 join 关联索引。**

**问：哪些 SQL 更容易触发 index merge？
答：OR/AND 混合筛选、多单列索引共存、大量 where 条件但缺少复合索引的查询。**

---

```
                  ┌─────────────────────┐
                  │      Index Merge     │
                  └───────────┬──────────┘
                              │
         ┌────────────────────┴────────────────────┐
         │                                         │
 ┌───────────────┐                       ┌─────────────────┐
 │ intersect(AND) │                       │ union(OR)        │
 │ 多索引取交集     │                       │ 多索引取并集       │
 └───────────────┘                       └─────────────────┘
                              │
                      ┌──────────────┐
                      │ sort_union   │
                      │ 合并+排序      │
                      └──────────────┘
```
