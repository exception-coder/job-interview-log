mysql_function_index_usage

✔ 用函数不一定导致索引失效（8.0后可优化）
🔥 函数索引可直接命中表达式结果
📌 原因是索引按“原值”组织，函数改变值
🚀 函数索引解决表达式无法命中索引的问题
⚠️ 非确定性函数不能建索引
➤ 维护成本上涨，更新写入更慢
🔍 字符串/日期/JSON 计算都可用函数索引
📈 常用于大小写不敏感、截取字段等场景
🧠 索引表达式必须 deterministic
✘ 无脑上函数索引会造成写压力过大

---

<details>
<summary>定义</summary>

**函数导致索引失效**：传统 InnoDB 索引基于字段原始值构造 B+Tree，表达式或函数作用后值改变，无法直接从索引树定位 → 导致扫描所有记录评估函数。

**函数索引（MySQL 8.0+）**：基于表达式结果建立的索引，使得执行计划可直接按表达式值命中索引，无需对行逐一计算。

</details>

<details>
<summary>原理</summary>

* 普通索引依赖“列原值排序”。函数改变原值 → 索引无序 → 必扫表。
* MySQL 8.0 表达式索引将表达式结果 materialize 到索引，与普通索引一样参与优化器成本模型。
* 执行 `WHERE func(col) = ...` 时，如存在 `INDEX (func(col))`，可直接利用表达式索引过滤。
* 索引维护成本增加：insert/update/delete 时需重新计算表达式并维护索引页。

</details>

<details>
<summary>关键点</summary>

* 函数索引适用于**确定性表达式**（相同输入 → 相同输出）。
* 非确定性表达式（如 `rand()`, `now()`, `uuid()`）不可建索引。
* JSON、字符串、日期、数学表达式都可作为函数索引。
* 适合对字符串部分截取、统一大小写查询等常见业务场景。
* 写压力上升，需要评估维护成本，不能无脑加。

</details>

<details>
<summary>扩展知识</summary>

* 表达式索引与虚拟列（stored/generated column）本质相通，可通过虚拟列 + 索引替代。
* 函数索引会参与选择性估计，与普通索引无异（合理补充）。
* 多字段组合函数，如 CONCAT，可构建复合逻辑键，避免额外存储字段（示例已给出）。

</details>

---

**问：为什么使用函数会导致索引失效？
答：索引按字段原值排序，函数转换后的值不在 B+Tree 中，无法索引定位，只能表扫。**

**问：MySQL 8.0 如何避免函数失效？
答：使用函数索引（expression index）。索引保存表达式结果，优化器可直接命中。**

**问：哪些函数不能建索引？
答：非确定性函数，包括 NOW()、RAND()、UUID()，以及部分存储函数。**

**问：函数索引对写性能影响大吗？
答：较大，insert/update/delete 都需维护表达式索引，需要业务评估。**

**问：LOWER()/UPPER() 查询怎么优化？
答：创建 `INDEX(lower(col))` 或 `INDEX(upper(col))`，可实现大小写不敏感检索。**

**问：搜索字符串子串可否建函数索引？
答：可做前缀/截断类函数索引，但无法覆盖任意位置 like '%xxx%'。**

**问：JSON 字段查询如何用索引？
答：对 JSON_EXTRACT(...) 建函数索引即可。**

**问：函数索引能否替代冗余字段？
答：可以，常用于计算类字段，如折扣价、组合键 concat(first,last)。**

---

```
        ┌────────────────────────┐
        │   查询中使用函数        │
        └───────────┬────────────┘
                    │
   ┌────────────────┴──────────────────┐
   │                                   │
┌───────────────┐             ┌────────────────────┐
│ 无函数索引 → 失效 │             │ 有函数索引 → 可命中   │
├───────────────┤             ├────────────────────┤
│ 改变原始值      │             │ 表达式值已存入索引      │
│ 全表扫描        │             │ 走索引过滤/范围检索     │
└───────────────┘             └────────────────────┘
```
