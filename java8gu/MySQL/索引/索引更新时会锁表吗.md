总结标题：mysql_index_update_lock_behavior

---

## 1）10 行极简速记版（纯文本）

✔ MySQL 5.6+ 支持 Online DDL，索引更新一般不锁表
🔥 Online DDL 仅“尽量减少”锁，不是完全无锁
⚠️ 复杂索引重建仍可能短暂表锁
📌 Online DDL 会抢占 CPU / IO，对业务有抖动
🚀 高峰期做索引变更风险极高
🔍 大表索引重建耗时长，会放大锁等待
🧠 主从复制下索引 DDL 会增加延迟
✨ Online DDL=降低阻塞，不等于无阻塞
📈 索引变更需评估资源、锁时间、主从延迟
✘ 误以为 Online DDL 完全不锁表是大坑

---

## 2）折叠式知识卡片版（Markdown）

<details>
<summary>定义</summary>

索引更新属于 DDL 操作。MySQL 自 **5.6 起引入 Online DDL**，允许大部分 DDL（含索引添加/删除）在执行期间保持表可读写，从而减少锁表时间。

但 Online DDL 并非完全无锁，其核心目标是：“尽可能不影响 DML”。

</details>

<details>
<summary>原理</summary>

### 1. Online DDL 能力

在大多数索引操作中：

* 不阻塞读
* 不阻塞写（大部分情况下）
* 在元数据变更阶段仍需加短暂的 **metadata lock (MDL)**
* 在构建新索引过程中后台线程会持续扫描表数据

### 2. 为什么仍可能锁表？

即使是 Online DDL，也存在需要锁的场景：

* **元数据修改阶段的 MDL lock**（不可避免）
* **重建数据或索引结构需要短暂的表锁**
* **复杂变更（如主键变更、大规模重建）无法完全 Online**
* **并发高、资源紧张时后台构建会与业务产生资源争用**

### 3. 系统资源争用

Online DDL 在后台执行，但会占用：

* CPU
* Buffer Pool
* redo/undo
* 磁盘 I/O

高峰期执行可能导致业务剧烈抖动。

### 4. 主从复制影响

* DDL 操作需要写入 binlog
* 从库会同步执行
* 大表 DDL 会导致**主从延迟急剧上升**

</details>

<details>
<summary>关键点</summary>

* Online DDL 是“减少锁表时间”，不是“无锁”
* 大表 + 索引重建 = 高峰期灾难
* MDL 依旧可能阻塞业务
* 索引 DDL 操作应安排在业务低峰期
* 主从架构中 DDL 会拖慢从库同步
* DDL 属于高风险变更，应有灰度/回滚方案

</details>

<details>
<summary>扩展知识</summary>

* 可用 `ALTER TABLE ... ALGORITHM=INPLACE, LOCK=NONE` 强制 Online 模式
* MySQL 8.0 Online DDL 支持更多类型（如重建外键、修改列默认值）
* 若 DDL 申请不到 MDL，容易出现“等待 MDL 导致全面阻塞”
* 可用 `pt-online-schema-change` 实现更安全的在线变更（非官方）

</details>

---

## 3）面试官追问（Q&A）

**问：Online DDL 为什么还会锁表？**
答：因为元数据变更（MDL）必须加锁，且某些结构性变更无法做到完全 Inplace。

**问：在业务高峰期做索引变更有什么风险？**
答：资源争用导致吞吐下降，MDL 等待可能造成全库阻塞。

**问：如何判断某条 ALTER 是否支持 Online DDL？**
答：`SHOW CREATE TABLE` + 文档 + `ALGORITHM=INPLACE` 是否报错。

**问：Online DDL 会阻塞写入吗？**
答：一般不会，但复杂操作（特别是重建索引）仍可能阻塞写操作。

**问：为什么主从延迟会因 Online DDL 增加？**
答：因为从库也需要执行同样的 DDL，且大表执行 DDL 耗时极长。

**问：DDL 执行慢的根本原因是什么？**
答：重建表、重建索引、大量 I/O，甚至全表扫描。

**问：如何安全上线大型索引变更？**
答：低峰期 + PTOSC/gh-ost + 限流策略 + MDL 监控。

---

## 4）示意图（ASCII）

```
           索引更新流程（Online DDL）

         ALTER TABLE ADD INDEX ...
                    │
                    ▼
        ┌───────────────────────────┐
        │    获取短暂 MDL（锁表）    │
        └───────────────────────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │  后台构建新索引（在线阶段）│
        │  - 扫描表                  │
        │  - 写入临时索引            │
        │  - 占用 CPU / IO           │
        └───────────────────────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │  元数据替换（短暂加锁）     │
        └───────────────────────────┘

结论：减少锁表 ≠ 不锁表
```
