### mysql_row_column_transform

#### 1）10 行极简速记版（纯文本）

✔ 行转列本质是条件聚合
🔥 CASE WHEN + SUM 是最稳的行转列套路
📌 IF 也能替代 CASE WHEN 做条件列
🚀 列转行靠 UNION ALL 拆列拼行
🧠 行转列对列值要求固定且已知
⚠️ 列转行会成倍增加结果行数
📈 CASE WHEN 聚合天然适配 GROUP BY
🔍 列转行常用于宽表规范化
✨ 动态列需借助动态 SQL 或应用层处理
✘ 无标准 PIVOT，MySQL 都靠手写语句

---

#### 2）折叠式知识卡片版

<details>
<summary>定义</summary>

行转列：将行中的某些取值（如 product=A/B）转为列名，通过聚合生成宽表结构。
列转行：将宽表的多列拆成多行，使数据更规范化、更易统计。

</details>

<details>
<summary>原理</summary>

* 行转列：利用 `CASE WHEN` 或 `IF` 在同一行构造条件列，配合 `SUM` 聚合按分组汇总生成新列。
* 列转行：对每一列构造一段 `SELECT ...`，并用 `UNION ALL` 拼接，使列名映射为 product 行，列值映射为 sales 行。

</details>

<details>
<summary>关键点</summary>

* 行转列依赖明确的列集合（A、B 固定可枚举）。
* 使用 `SUM(CASE WHEN...)` 可避免 NULL 干扰，默认填补为 0。
* 列转行通过多段 SELECT 拼接，列越多性能越差。
* `ORDER BY` 应放在最后一层 UNION 外部。
* MySQL 无原生 PIVOT/UNPIVOT，皆为手写方案。

</details>

<details>
<summary>扩展知识</summary>

* 若 product 列是动态的需使用应用层动态生成 SQL。
* 若行转列涉及大量列，可考虑 JSON 聚合或窗口函数优化（文中未给出，此为合理补充）。
* 宽表结构更适合报表，长表结构更适合 OLAP 分析与统计。

</details>

---

#### 3）面试官追问（Q&A）

**问：为什么行转列一定需要聚合函数？
答：同一分组下可能存在多行同类产品，必须通过 SUM/COUNT 等聚合保证结果唯一，否则结果不可确定。**

**问：CASE WHEN 与 IF 在行转列中如何取舍？
答：功能等价，但 CASE WHEN 语法标准、可读性好；IF 是 MySQL 特有函数，不适用于跨数据库。**

**问：行转列在列值不固定时如何处理？
答：需动态 SQL 生成 CASE 列，也可在应用层构建查询，MySQL 无法直接 PIVOT 动态列。**

**问：UNION 与 UNION ALL 在列转行中为何必须用 ALL？
答：UNION 会做去重，额外排序，可能误删数据且性能差。列转行逻辑不允许去重，只能用 ALL。**

**问：行转列对分组字段有什么要求？
答：必须唯一标识行（如 year），否则 CASE 列聚合将混合不同逻辑分组的数据。**

**问：列转行是否会影响索引利用？
答：会，因为每段 SELECT 都会单独查询并 UNION，MySQL 无法对最终结果使用原表复合索引。**

**问：在大数据量下如何优化行转列？
答：减少 CASE 数量、确保分组字段有索引、避免跨多表 JOIN 后再 PIVOT（此条为合理补充）。**

**问：为什么行转列示例中聚合函数使用 SUM 而非 MAX？
答：SUM 能处理多行汇总，MAX 在存在多行时可能导致数据丢失或歧义。**

**问：列转行的 ORDER BY 为什么必须写在最外层？
答：UNION ALL 各子查询顺序不保证，只有外层 ORDER BY 才能保证最终顺序一致。**

---

#### 4）示意图（ASCII）

```
行转列（CASE WHEN 聚合）
┌──────────────┐
│ year product sales │
└──────────────┘
        |
        | 条件列构造 (CASE WHEN)
        v
┌───────────────────────┐
│ year |  A |  B | ...  │
└───────────────────────┘


列转行（UNION ALL 拆列）
┌───────────────────────┐
│ year |  A |  B | ...  │
└───────────────────────┘
        |
        | 多段 SELECT + UNION ALL
        v
┌──────────────┐
│ year product sales │
└──────────────┘
```
