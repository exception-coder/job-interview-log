MySQL80_Remove_Query_Cache
✔ 查询缓存命中难，本质靠字符串精确匹配
⚠️ 任意表更新触发整表相关缓存失效
📌 内存占用高、管理成本大
🔥 不适合高写入的 InnoDB/MVCC 场景
🚀 8.0 直接移除，避免全局锁瓶颈
🔍 非确定性函数/临时表天然无法缓存
➤ 查询分布不均导致收益不稳定
🧠 多会导致“缓存反向拖慢”
✨ 官方长期建议关闭
📈 统一走优化器/执行计划更可控

---

## 折叠式知识卡片版

<details>
<summary>① 定义</summary>

* 查询缓存（Query Cache）是 MySQL 在执行 SELECT 时，将**结果集按查询文本缓存**的机制，跨 session 共享。
* 设计目标：减少重复查询的解析与执行开销。
* 文档强调：**基于字节级查询文本匹配**，包含大小写敏感；存在大量限制条件（函数、临时表、非确定性等无法使用）。
* MySQL 5.6 开始默认关闭；8.0 中完全移除。

</details>

<details>
<summary>② 原理</summary>

* Query Cache 维护一块全局内存区域，用于存储（查询文本 → 结果集）。
* 缓存以“表”为失效粒度：任意表更新会让所有相关缓存全部无效。
* 存储引擎（尤其 InnoDB + MVCC）导致结果可见性复杂，使用受限。
* 命中路径绕过解析/优化执行，但需要全局锁协调缓存结构（文档未提及，此为合理补充）。

</details>

<details>
<summary>③ 关键点</summary>

* **缓存易失效**：表级失效导致高写入场景几乎无收益。
* **内存占用高**：缓存文本 + 结果集，碎片化明显（合理补充）。
* **命中难**：必须字节级相同，带 bind 参数场景全无用。
* **会造成性能下降**：查询分布不均、频繁写入会导致锁争用、反而降低吞吐。
* **8.0 移除理由**：复杂性大、收益低、不稳定、影响可维护性。

</details>

<details>
<summary>④ 扩展知识</summary>

* MySQL 官方博客强调 Query Cache 是“反现代化”的，因为现代 OLTP 写多读少，缓存频繁无效（原文链接已给出）。
* 合理补充：8.0 推行更高效的优化器 + InnoDB Buffer Pool/二级缓存，比 Query Cache 更稳定。
* 分布式架构环境中，应用层缓存（Redis）更适合。

</details>

---

## 面试官追问（Q&A）

**问：为什么 MySQL 查询缓存需要字节级匹配？**
答：因为 Query Cache 不解析 SQL，只用 SQL 字符串作为 key，解析成本过高导致采用纯文本匹配。

**问：为什么写多场景下查询缓存反而会拖慢性能？**
答：每次表更新都要清理相关缓存并获取全局锁，会形成严重锁竞争。

**问：查询缓存与 InnoDB + MVCC 为什么天然冲突？**
答：MVCC 允许不同事务看到不同版本数据，而 Query Cache 是全局共享，难以保证可见性一致性。

**问：MySQL 8.0 为什么要彻底删除，而不是继续优化？**
答：架构层面已不适合：全局锁、碎片化、失效频繁、存储引擎不协同，修补成本高于收益。

**问：查询缓存对 OLAP 是否有用？**
答：理论上更适合读多写少场景，但 MySQL 在 OLAP 上并非优势，且管理复杂，官方仍选择移除。

**问：是否有替代方案？**
答：使用应用层缓存（Redis）、Proxy 层缓存、或 MySQL 8.0 的计划缓存（PS Cache）等更可控方式。

**问：为什么 bind 参数会导致查询缓存无法命中？**
答：因为绑定变量使 SQL 文本不同（?-style 参数），Query Cache 不做语义归一化。

---

## 示意图（ASCII）

```
        查询缓存命中流程（被移除前）

      ┌──────────────────────┐
      │   SQL 文本查缓存     │
      └───────────┬──────────┘
                  │命中
                  ▼
         ┌─────────────────┐
         │  返回缓存结果集  │
         └─────────────────┘

      若未命中：
      SQL → 解析 → 优化 → 执行 → 缓存结果（若可缓存）

      任意表更新：
      ┌────────────────────────┐
      │  清理该表相关缓存全部项 │
      └────────────────────────┘
```

（完）
