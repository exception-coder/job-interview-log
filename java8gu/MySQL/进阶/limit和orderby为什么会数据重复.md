总结标题
MySQL_Limit_OrderBy_Duplicate_Rows

---

## 1）10 行极简速记版（纯文本）

✔ ORDER BY 字段重复 → 返回顺序不稳定
⚠️ LIMIT 在排序不确定时可能抓到重复行
📌 ORDER BY 非唯一列 = 结果无确定性
🔥 同一 SQL 多次执行也可能返回不同结果
➤ 分页出现“上一页/下一页重复”常因排序字段不唯一
📈 官方明确：非唯一排序结果可自由重排
🧠 排序稳定性依赖于唯一键
✨ 最佳做法：ORDER BY 唯一列（如主键）
📌 LIMIT+ORDER BY 必须保证排序字段能唯一定位

---

## 2）折叠式知识卡片版

<details>
<summary>① 定义</summary>

* **问题背景**：
  使用 `ORDER BY + LIMIT` 做分页时，如果排序字段存在重复值，则 MySQL 对这些“相同排序值的行”没有稳定顺序保证。
* **表现**：

    * 分页时同一条数据可能出现在不同页。
    * 多次执行相同 SQL，结果集顺序不同。

</details>

<details>
<summary>② 原理</summary>

来自官方文档（MySQL 8.0）：

> 当 ORDER BY 列有重复值时，服务器可以以任意顺序返回这些行，此顺序可能因执行计划不同而变化。

原因：

* ORDER BY 只保证“按该列排序”，但**不保证相同值之间的相对位置**。
* LIMIT 截断结果集，依赖前面排序结果的稳定性。
* 排序字段不唯一 → MySQL 自由重排 → LIMIT 选中的行不一致 → 出现重复或遗漏。

例如：

```
ORDER BY create_time LIMIT 20, 10
```

如果 create_time 不是唯一值，则 20~30 的结果每次可能不同。

</details>

<details>
<summary>③ 关键点</summary>

* 非唯一字段排序 → 稳定性无法保证。
* LIMIT 分页要求顺序完全确定，否则会出现重复或跳行。
* 相同值之间的排序不确定性与：

    * 执行计划
    * 索引选择
    * 优化器策略
      有关系。
* 解决根本方案：为排序增加一个**唯一字段**。

</details>

<details>
<summary>④ 扩展知识</summary>

常见稳定排序写法：

```
ORDER BY create_time DESC, id DESC
```

或：

```
ORDER BY updated_at ASC, primary_key ASC
```

原则：

* 主排序字段：业务排序字段（时间、分数等）
* 次排序字段：唯一键（避免同值乱序）

如果 ORDER BY 仅时间/名称/状态等字段，必然导致不稳定分页。

</details>

---

## 3）面试官追问（Q&A）

**问：为什么 LIMIT+ORDER BY 会出现重复数据？**
答：ORDER BY 字段有重复值 → 相同排序值间顺序不确定 → LIMIT 抓取区间不稳定。

**问：为什么没有数据变更也会出现重复？**
答：因为乱序来自执行计划，不依赖数据变化。

**问：如何确保稳定分页？**
答：ORDER BY 必须包含至少一个唯一字段（如主键）。

**问：ORDER BY create_time 能保证分页稳定吗？**
答：不能，时间字段几乎必然重复。

**问：如果业务排序字段不是唯一的怎么办？**
答：加唯一键二次排序，如 `ORDER BY score DESC, id DESC`。

**问：为什么 GROUP BY、JOIN 也可能触发乱序？**
答：同样原因：未指定确定性排序字段，优化器可自由重排输出。

**问：MySQL 是否保证排序稳定性？**
答：只有排序键是唯一列时才稳定；否则显式不保证。

**问：如何排查重复分页问题？**
答：检查 ORDER BY 列是否有重复值 → 大多数问题来自这一点。

---

## 4）示意图（ASCII）

```
数据（按 create_time 排序）
time       id
----------------
2023-01-01  5
2023-01-01  9
2023-01-01 12
2023-01-01 14
↑ 这些行的顺序不确定

分页：
LIMIT 2,2
可能取到：
 (9,12) 或 (12,14)
```

```
正确稳定排序写法

ORDER BY create_time, id
  ↓ 唯一键保证稳定顺序
time       id
----------------
2023-01-01  5
2023-01-01  9
2023-01-01 12
2023-01-01 14
固定顺序 → 分页稳定
```

---

（总结完毕）
