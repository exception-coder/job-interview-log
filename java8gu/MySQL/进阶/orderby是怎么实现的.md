## 1）10 行极简速记版（纯文本）

✔ order by 能否走索引取决于优化器成本
🚀 索引有序，但不一定被用来排序
⚠️ 查询字段过多会导致放弃索引排序
🔥 filesort 主要依赖 sort_buffer 与临时文件
📌 sort_buffer 小则内存排，大则磁盘归并排
🧠 全字段排序一次回表更快但占内存
➤ row_id 排序节省内存但要二次回表
✨ limit 小时更容易触发索引排序
🔍 max_length_for_sort_data 决定排序模式
📈 本质：成本评估 + 空间权衡 + 回表次数取舍

---

## 2）折叠式知识卡片版（Markdown）

<details>
<summary>定义</summary>

MySQL 的 `ORDER BY` 排序支持两种实现路径：**索引排序**与 **filesort**。是否走索引完全由优化器基于成本评估决定。无法或不适合使用索引时，MySQL 会在内存或磁盘中执行 filesort 排序。

</details>

<details>
<summary>原理</summary>

* **索引排序**利用 B+Tree 的有序性直接输出有序结果，零额外排序成本。
* **filesort**基于 sort_buffer 排序；数据量超出 buffer 时使用磁盘临时文件 + 归并排序。
* 排序数据量与字段总长度超过 `max_length_for_sort_data` 时，MySQL 采用 **row_id 排序**，否则采用 **全字段排序**。
* 优化器综合考虑：字段长度、回表次数、LIMIT、索引覆盖情况等因素选择最优路径。

</details>

<details>
<summary>关键点</summary>

* 索引排序高概率条件：联合索引覆盖、符合最左前缀、LIMIT 小、前导列常量等。
* filesort 分为：

    * 全字段排序：所有字段入 sort_buffer，一次回表，内存占用大。
    * row_id 排序：仅排序字段+主键，排序后再回表取完整字段，回表多但占用小。
* sort_buffer_size、max_length_for_sort_data 大幅影响排序路径与性能。
* 临时文件排序基于多路归并，明显慢于内存排序。

</details>

<details>
<summary>扩展知识</summary>

* InnoDB B+Tree 索引按 key 有序，但**只有严格符合索引序的 ORDER BY 才能复用**。
* 多列排序只要顺序与索引一致才能利用索引，否则 filesort。
* 在大查询中，排序往往是性能瓶颈，尤其涉及磁盘归并时。
* 现代 MySQL 对 filesort 做了大量优化（快速路径、双 buffer merge）。

</details>

---

## 3）面试官追问（Q&A）

**问：为什么很多 order by 明明有索引却不走？
答：排序字段不满足最左前缀或查询字段太多导致无法索引覆盖、以及优化器认为回表成本高于 filesort。**

**问：filesort 一定是在磁盘排序吗？
答：不是。只有 sort_buffer 放不下排序行时才写临时文件，内存足够时完全在 RAM 中排序。**

**问：全字段排序和 row_id 排序的取舍是什么？
答：全字段排序只一次回表但占用内存大；row_id 排序节省内存但需二次回表，适用于单行数据较大情况。**

**问：为什么 limit 会提升使用索引排序的概率？
答：索引输出天然有序，limit 较小时只需扫描前 N 条，成本远低于全量排序。**

**问：max_length_for_sort_data 的作用是什么？
答：控制排序行能否直接放入 sort_buffer；行超限时 MySQL 强制降级为 row_id 排序。**

**问：临时文件排序为什么慢？
答：涉及随机 IO、文件写入和多路归并，整体延迟远大于内存排序。**

**问：filesort 与真正的文件排序是否一回事？
答：不是。filesort 是 MySQL 的排序算法名称，不代表一定使用文件。**

**问：哪些 order by 组合必定 filesort？
答：排序字段不在同一索引序列、排序方向与索引方向不一致、函数或表达式排序。**

**问：如何让 order by 更容易走索引？
答：建立合适的联合索引，使查询列与排序列被索引覆盖并满足排序序。**

---

## 4）示意图（ASCII）

```
排序路径选择逻辑：

        +----------------------+
        |   是否可用索引排序？ |
        +---------+------------+
                  |
        Yes ------+------ No
         |                |
         v                v
+----------------+   +--------------------+
|   索引直接输出  |   |      filesort      |
| 无排序成本     |   |  sort_buffer 排序   |
+----------------+   +----+---------------+
                         |
          +--------------+--------------------+
          |                                   |
  行长度 ≤ max_length_for_sort_data   行长度 > max_length_for_sort_data
          |                                   |
          v                                   v
+----------------------+          +------------------------+
| 全字段排序（一次回表）|          | row_id 排序（两次回表）|
+----------------------+          +------------------------+
                         |
      +------------------+------------------+
      |                                     |
 内存足够（无临时文件）         内存不足（磁盘临时文件归并）
```

---
