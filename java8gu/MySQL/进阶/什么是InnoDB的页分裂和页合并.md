总结标题
InnoDB_Page_Split_and_Merge

---

## 1）10 行极简速记版（纯文本）

✔ 页分裂=页满插入新键被迫拆页
🔥 无序主键最容易触发分裂
📌 分裂会沿 B+ 树向上连锁传播
⚠️ 页合并=删除导致页过稀疏
📈 分裂/合并都会破坏局部性与性能
🧠 分裂造成空间浪费与碎片
🚀 自增主键可极大降低分裂概率
➤ 批量插入比逐条插入更友好
📌 频繁删除容易触发合并
✨ 逻辑删除优于物理删除

---

## 2）折叠式知识卡片版（Markdown）

<details>
<summary>① 定义</summary>

**页分裂（Page Split）**
当数据页（16KB）空间不足以容纳新记录时，InnoDB 会新建一个页，将原页部分数据迁移过去，从而保持 B+ 树的有序性与平衡性。

**页合并（Page Merge）**
当删除导致页利用率过低时，InnoDB 会尝试将相邻页合并为一个页，减少树高度与存储浪费。

</details>

<details>
<summary>② 原理</summary>

### 页分裂

1. 插入新键 → 查到目标页
2. 页已满 → 分裂为两个页：旧页 + 新页
3. 重新分配记录区间
4. 更新父节点指向，必要时会向上级继续分裂
5. 可能一路分裂到根节点，导致 B+ 树高度增加

### 页合并

1. 删除记录 → 页变稀疏
2. 判断是否可与兄弟页合并（空间足够）
3. 合并两页 → 回收一页
4. 更新父节点索引项，必要时父节点也可被合并

</details>

<details>
<summary>③ 关键点</summary>

* 分裂与合并是 **B+ 树保持平衡的核心机制**。
* 页分裂成本很高：移动大量记录、修改父节点、可能连锁分裂。
* 合并也有开销：数据搬移、索引调整。
* 随机主键（如 UUID/varchar）高概率落在任意位置 → 高分裂率。
* 自增主键顺序插入 → 新数据落在“末尾” → 极少分裂。
* 删除太多可能导致页被频繁合并 → 引发性能抖动。

</details>

<details>
<summary>④ 扩展知识</summary>

* **空间碎片**：新分出的页通常空闲多，导致磁盘空间利用率下降。
* **避免策略**：

    * 使用自增主键（最有效）
    * 批量插入，减少分裂次数
    * 尽量逻辑删除避免触发页合并
    * 合理规划索引列顺序与类型
* 可在 InnoDB 中调节参数优化页管理（如 fill factor），但生产环境中不常改动。

</details>

---

## 3）面试官追问（Q&A）

**问：页分裂为什么会连锁触发？**
答：分裂会增加父节点子指针数量，父页若也满则继续分裂，直至树顶。

**问：为什么 UUID 主键不适合作为聚簇索引？**
答：其值随机性强，会向树各处插入，分裂频繁，造成碎片与树高度增加。

**问：页分裂是否一定意味着性能下降？**
答：是的。记录搬移、修改父节点、额外 IO 与锁争用都使插入性能下降。

**问：删除操作为什么会引发页合并？**
答：删除导致页使用率下降，为节省空间和降低树高度，InnoDB 会合并邻页。

**问：如何判断系统是否受到页分裂影响？**
答：可观察插入 TPS 波动、页分裂计数、索引空间增大、redo/IO 上升。

**问：批量插入能降低页分裂的原因？**
答：批量插入一般按排序后的主键写入，更接近有序插入。

**问：逻辑删除为何能避免页合并？**
答：行仍占用物理空间，不会导致页利用率骤降，因此不会触发合并逻辑。

**问：页分裂对查询性能的影响是什么？**
答：树高度与碎片增加 → 页遍历次数变多 → cache 命中率下降。

---

## 4）示意图（ASCII）

### 页分裂

```
原页 (满)                        分裂后
+------------------+        +-----------+  +-----------+
| 1 | 2 | 5 | 7 | 9 |  -->  | 1 | 2 | 5 |  | 7 | 9 | 3 |
+------------------+        +-----------+  +-----------+
                                   新页插入排序后重新分布
```

### 页合并

```
删除后页利用率过低

+-----------+   +-----------+
| 1 | 2 |   |   | 3 | 4 |   |
+-----------+   +-----------+
        ↓ 合并
+---------------------------+
| 1 | 2 | 3 | 4 |           |
+---------------------------+
```

---

（总结完毕）
