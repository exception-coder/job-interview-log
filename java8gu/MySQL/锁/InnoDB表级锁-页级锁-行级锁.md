InnoDB_lock_levels
✔ InnoDB 只支持“全局/表级/行级锁”，**没有页级锁**
📌 表级锁主要靠意向锁、AUTO-INC 锁、MDL 锁组成
🔥 UPDATE 无索引≠表锁，本质是**锁主键索引范围**
➤ 行级锁基于索引，扫描全表也只锁命中行
🧠 表级显式 LOCK TABLES 极少用，DDL 用 MDL
⚠️ 大量行级锁冲突会自动退化成更粗粒度控制
📈 锁粒度越细并发越高，但代价是管理开销

---

## 折叠式知识卡片版

<details>
<summary>① 定义</summary>

* **全局锁**：锁整个实例（如 FTWRL），所有表只读。
* **表级锁**：锁某张表，用于元数据、插入自增、手动 LOCK TABLES。
* **行级锁**：InnoDB 默认粒度，通过索引项加锁，最小限度控制并发。
* **页级锁**：InnoDB 不支持（MyISAM 支持）。

</details>

<details>
<summary>② 原理</summary>

* **全局锁**：直接阻塞全库写，典型用于一致性备份。
* **表级锁类型**：

    * *意向锁（IS/IX）*：表级声明行级锁意向，用于与表锁兼容性判断。
    * *AUTO-INC 锁*：保证自增值分配的原子性。
    * *MDL 锁*：DDL 加排他 MDL，DML 加共享 MDL，保护元数据一致性。
    * *显式 LOCK TABLES*：READ（共享）/WRITE（排他）。
* **行级锁**：基于索引项加锁；锁住记录及其 GAP（RR 隔离级别下）。

</details>

<details>
<summary>③ 关键点</summary>

* UPDATE 未命中索引 → **全表扫描**但锁的是符合条件的记录（锁主键，不是锁整表）。
* DML 不会自动加表锁，除了极端情况（例如行锁成本过高可能退化）。
* DDL 强制使用 MDL 排他锁，DML 会被阻塞。
* InnoDB 尽量保持行级粒度，不轻易升级到表锁。

</details>

<details>
<summary>④ 扩展知识</summary>

* “无索引 UPDATE 就锁表”是误解，本质是锁主键索引上所有满足条件的行（扫描成本高但不是表锁）。
* 隐式主键（隐藏 row_id）会在无主键表上作为行级锁对象。
* 高并发热点更新应避免非索引条件导致全表扫描锁冲突（经验推断补充）。

</details>

---

## 面试官追问（Q&A）

**问：InnoDB 为何不支持页级锁？**
答：页级锁粒度过粗且收益有限，InnoDB 的设计目标是高并发，因此使用行级锁 + 多版本隔离替代页锁。

**问：意向锁到底有什么作用？**
答：避免事务逐行检查锁冲突，通过 IS/IX 与表锁快速判断兼容性，加速锁管理。

**问：为什么 UPDATE 无索引不是锁表？**
答：InnoDB 行锁基于索引项，未命中索引会扫描全表但最终只锁满足条件的主键索引记录。

**问：DDL 为什么必须用 MDL？**
答：元数据需要一致性，避免结构变更与 DML 并发导致崩溃或不一致。

**问：AUTO-INC 锁如何影响并发？**
答：早期版本串行分配自增值；新版本采用基于事务分配模式，但仍可能在热点表成为瓶颈。

**问：行锁会升级为表锁吗？**
答：InnoDB 不会“自动升级”，但在极端情况下可能采用更粗粒度的内部锁策略来保护一致性（如大量扫描更新）。

**问：GAP Lock 什么时候出现？**
答：RR 隔离级别下，防止幻读；范围 UPDATE/SELECT … FOR UPDATE 都会锁区间。

---

## 示意图（ASCII）

```
锁粒度层级

+----------------------------+
| Global Lock (FTWRL)       |
+----------------------------+
          ↓
+----------------------------+
| Table Locks               |
|  - Intent Locks (IS/IX)   |
|  - AUTO-INC Lock          |
|  - MDL (DDL)              |
|  - LOCK TABLES            |
+----------------------------+
          ↓
+----------------------------+
| Row Locks                 |
|  - Record Lock            |
|  - Gap Lock               |
|  - Next-Key Lock          |
+----------------------------+
```

（完）
