✔ InnoDB 锁体系由粒度锁 + 意向锁两层协同
🚀 行级锁本质锁索引记录，不锁“行”本身
📌 插入意向锁解决并发插入同一间隙冲突
🧠 AUTO-INC 表级锁保证自增主键单调唯一
⚠️ IS/IX 是表级声明意图，不参与真正加锁
🔥 Next-Key = 记录锁 + 间隙锁，解决幻读
🔍 无主键会自动生成隐藏聚簇索引供加锁
📈 共享/排他锁控制读写互斥关系
➤ 多事务范围操作易因间隙锁导致锁等待
✔ 行锁依赖索引，未走索引会“锁全表”

---

## 2）折叠式知识卡片版

<details>
<summary>定义</summary>

* **共享锁（S）**：读锁，多个事务可共享，禁止修改。
* **排他锁（X）**：写锁，独占资源，可读可写。
* **意向锁（IS/IX）**：表级声明，将要在某行加 S/X 锁，用于加速锁冲突检测。
* **记录锁（Record Lock）**：加在索引记录上的行级锁。
* **间隙锁（Gap Lock）**：锁定索引记录之间的间隙。
* **Next-Key Lock**：Record + Gap（左开右闭）。
* **插入意向锁**：插入前在间隙上的一种特殊 Gap Lock。
* **AUTO-INC 锁**：保证自增主键连续性的表级锁。

</details>

<details>
<summary>原理</summary>

* InnoDB 所有行锁基于 **索引记录** 加锁，无索引则创建隐藏聚簇索引。
* 意向锁通过表级标记加速冲突判断——无需遍历所有行锁。
* 插入意向锁允许多个事务向同一间隙不同位置插入，实现并发插入。
* AUTO-INC 锁受 `innodb_autoinc_lock_mode` 管理，可在顺序性与并发性之间调节。
* Next-Key Lock 用于防止范围查询的幻读，是 RR 下的关键。

</details>

<details>
<summary>关键点</summary>

* 行级锁不锁“行”，而锁“索引项”。
* 不走索引会导致锁定隐藏索引 → 实质全表锁定。
* 间隙锁与 next-key 对范围操作影响最大，常见锁等待来源。
* 插入意向锁只阻塞插入同一位置，不阻塞不同位置。
* AUTO-INC 锁为表级锁，是自增列一致性关键。

</details>

<details>
<summary>扩展知识</summary>

* InnoDB 不支持页级锁，但 MyISAM 支持。
* 意向锁不会真正阻塞行操作，它只是“权限声明”。
* DDL 存在 MDL（元数据锁），会阻塞读写。
* 乐观锁属于应用层策略，与 InnoDB 行锁机制不同。

</details>

---

## 3）面试官追问（Q&A）

**问：为什么 InnoDB 行锁需要依赖索引？**
答：行锁基于 B+Tree 节点进行加锁，如果查询没用到索引，必须锁住整棵树，形成全表行锁效果。

**问：意向锁为什么是表级锁？**
答：用于声明“将对某些行加 S/X 锁”，加速冲突检测，避免加锁时遍历整张表所有行锁。

**问：Next-Key Lock 如何解决幻读？**
答：它在范围上锁定记录 + 间隙，使其他事务无法插入范围内的新行。

**问：插入意向锁和间隙锁的区别？**
答：插入意向锁是插入前自动加的特殊间隙锁，用于协调同一间隙不同位置的并发插入。

**问：AUTO-INC 锁是否阻塞所有插入？**
答：模式 0/1 阻塞强，模式 2（批量模式）并发最高，但主键值可能不连续。

**问：为什么说行锁是“索引锁”？**
答：锁的是索引记录，不是物理行；没有索引会创建隐藏聚簇索引供加锁。

**问：间隙锁为何容易导致锁等待？**
答：范围查询会锁住大段区间，其他事务的插入、更新都会被阻塞。

**问：共享锁和排他锁可否共存？**
答：S 锁可并发，X 锁独占；S 与 X 冲突。

---

## 4）示意图（ASCII）

```
                +----------------------+
                |     InnoDB 锁体系     |
                +----------------------+
                           |
        +------------------+------------------+
        |                                     |
   表级锁（IS/IX/AUTO-INC）              行级锁（Record/Gap/Next-Key）
        |                                     |
   权限声明，加速冲突判断                基于索引记录进行加锁
        |                                     |
        +------------------+------------------+
                           |
                   最终锁冲突判定
```
